{% extends 'translator/base.html' %}

{% block title %}–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ - –ê–Ω–≥–ª–æ-—Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫{% endblock %}

{% block content %}
<div id="translate-tab" class="tab-content active">
    <div class="translator-box">
        <h2>üî§ –ü–µ—Ä–µ–≤–æ–¥ —Å–ª–æ–≤</h2>
        <div class="form-group">
            <label for="wordInput">–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ:</label>
            <input type="text" id="wordInput" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: hello, world, cat..." autocomplete="off">
        </div>
        <button onclick="translateWord()" class="btn btn-primary">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
        
        <div id="result" class="result"></div>
    </div>
</div>

<div id="add-tab" class="tab-content">
    <div class="translator-box">
        <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ —Å–ª–æ–≤–∞—Ä—å</h2>
        <div class="form-group">
            <label for="englishWord">–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ:</label>
            <input type="text" id="englishWord" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="russianTranslation">–†—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥:</label>
            <input type="text" id="russianTranslation" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥" autocomplete="off">
        </div>
        <button onclick="addNewWord()" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ª–æ–≤–∞—Ä—å</button>
        
        <div id="addResult" class="result"></div>
    </div>
</div>

<!-- –°–∫—Ä—ã—Ç—ã–π CSRF —Ç–æ–∫–µ–Ω -->
{% csrf_token %}
<script>
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
</script>
{% endblock %}

{% block scripts %}
<script>
function translateWord() {
    const word = document.getElementById('wordInput').value.trim();
    const resultDiv = document.getElementById('result');
    
    if (!word) {
        showResult('error', '–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    resultDiv.innerHTML = '‚è≥ –ò—â–µ–º –ø–µ—Ä–µ–≤–æ–¥...';
    resultDiv.className = 'result success';
    resultDiv.style.display = 'block';
    
    // AJAX –∑–∞–ø—Ä–æ—Å —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/translate/', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('X-CSRFToken', getCSRFToken());
    
    xhr.onload = function() {
        const response = JSON.parse(xhr.responseText);
        
        if (response.success) {
            let message = `<div class="word-pair">${response.english_word} ‚Üí ${response.russian_translation}</div>`;
            if (response.from_simple_dict) {
                message += '<div style="text-align: center; color: #666; font-size: 0.9em;">üìö –ò–∑ –±–∞–∑–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è</div>';
            } else {
                message += '<div style="text-align: center; color: #666; font-size: 0.9em;">üíæ –ò–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</div>';
            }
            showResult('success', message);
        } else {
            showResult('error', response.error);
        }
    };
    
    xhr.onerror = function() {
        showResult('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    };
    
    xhr.send('word=' + encodeURIComponent(word));
}

function addNewWord() {
    const englishWord = document.getElementById('englishWord').value.trim();
    const russianTranslation = document.getElementById('russianTranslation').value.trim();
    const resultDiv = document.getElementById('addResult');
    
    if (!englishWord || !russianTranslation) {
        showAddResult('error', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    resultDiv.innerHTML = '‚è≥ –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ...';
    resultDiv.className = 'result success';
    resultDiv.style.display = 'block';
    
    // AJAX –∑–∞–ø—Ä–æ—Å —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/add-word/', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.setRequestHeader('X-CSRFToken', getCSRFToken());
    
    xhr.onload = function() {
        const response = JSON.parse(xhr.responseText);
        
        if (response.success) {
            showAddResult('success', response.message);
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('englishWord').value = '';
            document.getElementById('russianTranslation').value = '';
        } else {
            showAddResult('error', response.error);
        }
    };
    
    xhr.onerror = function() {
        showAddResult('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    };
    
    xhr.send('english_word=' + encodeURIComponent(englishWord) + 
             '&russian_translation=' + encodeURIComponent(russianTranslation));
}

function showResult(type, message) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = message;
    resultDiv.className = 'result ' + type;
    resultDiv.style.display = 'block';
}

function showAddResult(type, message) {
    const resultDiv = document.getElementById('addResult');
    resultDiv.innerHTML = message;
    resultDiv.className = 'result ' + type;
    resultDiv.style.display = 'block';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
document.getElementById('wordInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        translateWord();
    }
});

document.getElementById('englishWord').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addNewWord();
    }
});

document.getElementById('russianTranslation').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addNewWord();
    }
});
</script>
{% endblock %}